<?php

namespace app\controllers;

use Yii;
use yii\filters\AccessControl;
use yii\web\Controller;
use yii\web\Response;
use yii\filters\VerbFilter;
use app\models\LoginForm;
use app\models\ContactForm;
use app\models\WscheckForm;
use yii\web\UploadedFile;

class MixcheckController extends Controller
{	public $enableCsrfValidation=false;

    public function actionIndex()
    {	//echo "!!!!";exit;
        return $this->render('index');
    }
	
	
	
	public function behaviors()
    {
        return [
            'access' => [
                'class' => AccessControl::className(),
                'only' => ['explode','add','newproduct','explodejd','addjd'],
                'rules' => [
                    [
                        'actions' => ['explode','add','newproduct','explodejd','addjd'],
                        'allow' => true,
                        'roles' => ['@'],
                    ],
					[
                        'allow' => true,
                        'actions' => ['index'],
                        'roles' => ['@'],
                    ],
                ],
            ],
            'verbs' => [
                'class' => VerbFilter::className(),
                'actions' => [
                    'logout' => ['post'],
                ],
            ],
        ];
    }
	
	public function actionJdcheck(){
		//echo "!!!";exit;
		
		$month=1804;
		$sql="SELECT a.tb_item_id,a.name,b.name as brand_name,month,avg from (SELECT tb_item_id,name,shop_name,ali_alias_bid,date_format(date,'%y%m') month,sum(sales/100) ss,sum(num) sn,sum(sales/100)/sum(num) avg FROM artificial.entity_1359_jd_final where (is_mix=0 or is_mix is null) and tb_item_id not in(1713838,1713832,1713846,2971313)  and tb_item_id not like '%\_%' and date_format(date,'%y%m')=$month and shop_type in('京东自营','京东自营POP')  group by tb_item_id,month order by sum(sales) desc limit 100) a left join dw_entity.brand b on a.ali_alias_bid=b.bid ;";
		//echo $sql;
		$data = Yii::$app->db->createCommand($sql)->queryAll();
		//print_r($result);
		return $this->render('index',['data' => $data]);
		
		
	}
	


				  
	public function actionTmcheck(){
		
		$month=1804;
		$sql="SELECT a.tb_item_id,a.name,shop_name,b.name as brand_name ,month,ss,sn,avg from (SELECT tb_item_id,name,shop_name,alias_bid,month,sum(sales/100) ss,sum(num) sn,sum(sales/100)/sum(num) avg FROM artificial.entity_1359_item_final where is_mix=0 and tb_item_id not like '%\_%'  and tb_item_id not in(19268330504,37241210535,529537812096,551477582638,537956016240,549012007942,520943674824,37617354273,531160520044,530523414827,538850144726,17345546169,533265865255,547424192250,533333820511,40706217867,533220367917,549233039136,14103741832,547462201410,548221327800,44029281730,14572957126,543565905141,549219967879,551498170941,551056413323,541055546258,546002395506,529199084917,541111225069,550897989251,533296980519,520952139078,546261535649,549119826615,550490430145,534010958297,550540627332,541169531886,551718301256,536197070876,523737238926,534858684756,521293158275,540897200164,531500503266,40223287254,529742081714,546455630298,531172828125,530281813566,538304988370,540615955415,538994488503,524745628731,544414476882,534744972408,541262230065,532602538696,531493939222,532076722056,539854982190,523807190227,545284938765,542169018608,547527269696,532603642908,525270878896,538919766386,540697151157,551974843558,523746256545,525455081788,17294079577,539366124100,10913250663,16505351217,533220474800,529284034772,544472212317,531851580743,43784059501,523714227013,540557833968,542312250718,540297613200,547609622660,538883106821,534306636210,536966655180,537116460739,544747801155,525286144101,546836425231,525272493108,542074632842,545967773814,548682413899,547679701492,533624811133,550202819632,529022432701,550471860694,541207980323,552026167552,551850673145,532805434133,537956016240,531160520044,520943674824,530523414827,37617354273,549012007942,538850144726,17345546169,40706217867,533220367917,551056413323,547424192250,14103741832,549233039136,548221327800,549219967879,533333820511,541111225069,533265865255,546002395506,547462201410,42289229310,14572957126,533802271835,44029281730,533265533636,551498170941,543565905141,541055546258,550897989251,533296980519,541169531886,521042072014,527394151312,550490430145,550651284925,530463220461,551638812060,527438630490,551729138316,553101189487,552697958730,551718301256,541165494737,553104356806,17294079577,531500503266,539366124100,538994488503,530281813566,529742081714,10913250663,521293158275,525455081788,16505351217,531851580743,529284034772,540897200164,540615955415,536197070876,523737238926,523746256545,523714227013,40223287254,544472212317,43784059501,534858684756,523807190227,533220474800,534744972408,545284938765,532603642908,538919766386,525270878896,531172828125,524745628731,538304988370,540697151157,542195205226,544414476882,541262230065,532602538696,551974843558,532076722056,531493939222,539854982190,542169018608,547527269696,540557833968,532805434133,550471860694,540297613200,546836425231,537116460739,536966655180,550202819632,544148616165,547482388501,551611937631,542312250718,551384712523,543478873393,533624811133,547609622660,541207980323,544747801155,525286144101,529022432701,542074632842,551850673145,552618260793,548600430872,549054853892,537956016240,538942157514,539415229737,530523414827,531160520044,37617354273,520943674824,543553163062,538850144726,542305052374,40706217867,14572957126,541111225069,537594302548,541169531886,542986708740,10913250663,531500503266,523737238926,523807190227,530281813566,521293158275,524745628731,534744972408,532603642908,525270878896,529742081714,531172828125,538304988370,529284034772,540212683252,534858684756,532602538696,541262230065,532076722056,539854982190,542169018608,540697151157,538994488503,525455081788,544472212317,16505351217,523714227013,531851580743,531493939222,523746256545,533624811133,536966655180,537116460739,525286144101,540557833968,542312250718,525201313448,544148616165,540123833473,532805434133,537956016240,37617354273,531160520044,543553163062,520943674824,530523414827,538942157514,539415229737,542305052374,538850144726,40706217867,14572957126,541055546258,541111225069,537594302548,541169531886,524745628731,532602538696,521293158275,523807190227,541262230065,531500503266,523737238926,530281813566,529742081714,534744972408,532076722056,539854982190,525270878896,538304988370,538994488503,531172828125,534858684756,527268334712,542169018608,540697151157,542195205226,545284938765,532603642908,544414476882,529284034772,523746256545,531493939222,525455081788,533220474800,10913250663,16505351217,531851580743,540212683252,523714227013,544472212317,542641687933,540557833968,542312250718,533624811133,536966655180,537116460739,544747801155,525272493108,540123833473,529022432701,545310395504,541370028344,544148616165,542074632842,532805434133,537956016240,520943674824,37617354273,530523414827,531160520044,538850144726,14572957126,40706217867,44029281730,14103741832,541111225069,541055546258,546261535649,541169531886,541165494737,523737238926,534858684756,521293158275,530281813566,531500503266,532076722056,529742081714,524745628731,523807190227,541262230065,534744972408,532602538696,539854982190,542169018608,545284938765,532603642908,525270878896,538994488503,540697151157,538304988370,531172828125,536197070876,544414476882,542195205226,547527269696,531851580743,544472212317,539366124100,531493939222,16505351217,525455081788,523746256545,10913250663,523714227013,43784059501,529284034772,546455630298,533220474800,536966655180,525272493108,544148616165,542641687933,542312250718,533624811133,541207980323,538883106821,525286144101,544747801155,542074632842,546221080045,540557833968,537116460739,545599962397,546837829184,532805434133,547609622660,546836425231,537956016240,531160520044,530523414827,37617354273,520943674824,538850144726,14572957126,44029281730,17345546169,543565905141,40706217867,14103741832,549233039136,549219967879,529199084917,541055546258,541111225069,546261535649,549119826615,541169531886,541165494737,534744972408,523807190227,546455630298,524745628731,531500503266,40223287254,523737238926,539854982190,521293158275,529742081714,540615955415,530281813566,532076722056,536197070876,538919766386,525270878896,545284938765,542169018608,538304988370,531172828125,540697151157,538994488503,544414476882,534858684756,532602538696,541262230065,547527269696,532603642908,542195205226,533220474800,523746256545,523714227013,529284034772,16505351217,10913250663,531493939222,43784059501,539366124100,531851580743,525455081788,544472212317,544148616165,542074632842,546837829184,542312250718,533624811133,547609622660,538883106821,537116460739,546836425231,525286144101,541089184824,525272493108,529022432701,542641687933,541839956141,548600430872,536966655180,544747801155,546221080045,540557833968,532805434133,545171512584,537956016240,537956016240,541491570565,531160520044,520943674824,531160520044,37617354273,537419618503,538942157514,37617354273,520943674824,538942157514,520943674824,531160520044,37617354273,37617354273,537419618503,531160520044,520943674824,537419618503,538942157514,538942157514,543553163062,37617354273,530523414827,520943674824,531160520044,528860361644,537182658806,528792026083,528860361644,538850144726,538123746537,528792026083,538850144726,540009294545,538850144726,528860361644,538123746537,538850144726,541726727753,542905972721,538123746537,14572957126,14572957126,14572957126,14572957126,14572957126,14572957126,14572957126,14572957126,14572957126,14572957126,14572957126,541111225069,541111225069,40706217867,14572957126,40706217867,541111225069,526378379842,529614237644,533956321145,533956321145,531700997664,531700997664,534545671758,531303486746,537594302548,537594302548,531303486746,537594302548,541169531886,541169531886,541165494737,537594302548,541169531886,541165494737,524745628731,527268334712,527268334712,524745628731,525504280840,523714227013,523737238926,523746256545,529047138866,529284034772,523737238926,523714227013,524745628731,525504280840,529742081714,529742081714,530281813566,524745628731,531500503266,531500503266,527268334712,529284034772,525504280840,523746256545,523737238926,525270878896,523714227013,529742081714,524745628731,531500503266,527268334712,530281813566,532947367219,532947367219,532553366095,532553338029,523737238926,527160374521,525504280840,529284034772,523746256545,525270878896,523714227013,531493939222,10913250663,531172828125,532603642908,532602538696,524745628731,521293158275,531500503266,529742081714,532947367219,530281813566,532602538696,532603642908,527268334712,524745628731,527268334712,525504280840,523714227013,523737238926,527160374521,530281813566,523746256545,525270878896,523737238926,531172828125,532553366095,10913250663,531493939222,533220474800,529284034772,523714227013,525504280840,534858684756,521293158275,524745628731,530281813566,532947367219,529742081714,531500503266,527268334712,534858684756,531493939222,525504280840,523737238926,523746256545,529284034772,525270878896,10913250663,532553366095,533220474800,531172828125,523714227013,530281813566,532602538696,532603642908,524745628731,525504280840,521293158275,523807190227,531500503266,529742081714,527268334712,523714227013,523746256545,531493939222,532602538696,532603642908,525504280840,533220474800,537160034926,529284034772,525270878896,10913250663,531172828125,523737238926,534858684756,538304988370,538767457166,524745628731,527268334712,532602538696,532603642908,523807190227,530281813566,521293158275,531500503266,529742081714,538994488503,538994488503,538304988370,534858684756,529284034772,10913250663,525270878896,523714227013,531851580743,523746256545,531493939222,533220474800,523737238926,531172828125,538767457166,539854982190,532076722056,540212683252,540671621147,10913250663,523714227013,531500503266,531851580743,521293158275,524745628731,523807190227,534858684756,532602538696,530281813566,16505351217,529742081714,527268334712,523746256545,539600485156,529284034772,531172828125,531493939222,525455081788,523737238926,532076722056,539854982190,540212683252,538994488503,525270878896,541262230065,538304988370,533220474800,529284034772,531493939222,523737238926,531172828125,10913250663,525270878896,523746256545,523714227013,525455081788,16505351217,531851580743,538767457166,532603642908,540671621147,541262230065,539600485156,533220474800,542169018608,532076722056,523807190227,529284034772,530281813566,524745628731,531172828125,529742081714,523737238926,10913250663,521293158275,531500503266,539854982190,527268334712,538767457166,532603642908,538994488503,541262230065,534858684756,540212683252,532602538696,538304988370,542169018608,525270878896,539600485156,540671621147,531493939222,531851580743,523746256545,533220474800,523714227013,525455081788,16505351217,523952765214,526288293657,525201313448,525286144101,525272493108,524920751772,527544106510,525272493108,525286144101,523952765214,523952765214,525286144101,525201313448,526288293657,528535767171,528535767171,525201313448,528535767171,529382008334,529341101046,529022432701,529022432701,526288293657,526288293657,525272493108,524920751772,525286144101,531517381213,528535767171,531830693911,529341101046,531517381213,526288293657,529022432701,525286144101,525272493108,525272493108,526288293657,533238164069,531602679044,529022432701,532805434133,535633448108,531602679044,531374706321,523754424258,525272493108,535633448108,535057328481,535057328481,531374706321,531602679044,532805434133,536335432054,529022432701,525201313448,525201313448,536335432054,536966655180,525286144101,526288293657,529022432701,531602679044,525201313448,523754424258,536966655180,537116460739,525286144101,537116460739,525272493108,532805434133,526288293657,532805434133,531602679044,533624811133,523754424258,536954281937,539108820491,539108820491,532805434133,536966655180,525286144101,525272493108,539428257402,526288293657,529022432701,539797219875,539961003006,539035969793,538813661483,539354297385,539704326156,539704326156,539079445929,539079445929,536954281937,537116460739,539528642764,539568268532,531602679044,532805434133,539961003006,539035969793,533624811133,539354297385,539704326156,539079445929,536966655180,539428257402,539528642764,539568268532,525272493108,540734500873,529022432701,540123833473,540123833473,539979834501,539633131530,538967741255,534306636210,537116460739,525286144101,526288293657,541824111633,539935949946,541370028344,525201313448,533624811133,539928565164,536966655180,525286144101,525272493108,542081833783,541824111633,540123833473,542074632842,542074632842,542679555008,539675285153,541982313558,538967741255,525201313448,542312250718,537116460739,540734500873,529022432701,542081833783,540557833968,543584552059,553104356806,541165494737,555080368204,550921887022,552781468109,554001237679,530463220461,553392599163,550490430145,527438630490,527394151312,541169531886,521042072014,536716652876,555378118090,550897989251,521680603667,40706217867,549233039136,39548043169,14572957126,548221327800,533265533636,533265865255,541111225069,42289229310,543565905141,44029281730,533333820511,551498170941,17345546169,533802271835,541055546258,549219967879,547462201410,547424192250,533220367917,538850144726,549012007942,37617354273,520943674824,531160520044,530523414827,537956016240,536716652876,544472212317,531851580743,542337666603,17294079577,540897200164,521293158275,540615955415,10913250663,533220474800,523737238926,523746256545,542169018608,539366124100,536197070876,16505351217,523714227013,530281813566,529284034772,40223287254,534858684756,529742081714,538994488503,531500503266,547527269696,525270878896,532603642908,524745628731,531172828125,540697151157,538304988370,525455081788,534744972408,532602538696,541262230065,532076722056,551974843558,523807190227,539854982190,545284938765,538919766386,542195205226,554864744510,555131768952,544414476882,528810764279,555331179846,538154620073,532805434133,542312250718,550202819632,536966655180,546836425231,542074632842,533624811133,554895846568,543478873393,540297613200,554006838827,537116460739,548600430872,541207980323,544747801155,525286144101,545171512584,551850673145,554898208704,555093954396,549054853892,525272493108,525201313448,556675173531,537956016240,549012007942,530523414827,556124949272,37617354273,520943674824,531160520044,557483651277,557394858514,538850144726,549219967879,17345546169,14572957126,533333820511,548639461152,547424192250,533220367917,40706217867,548221327800,533265865255,533265533636,42289229310,551498170941,547462201410,549233039136,44029281730,533802271835,550897989251,543565905141,541111225069,541055546258,39548043169,555378118090,541169531886,521042072014,550490430145,554973981569,555080368204,530463220461,527394151312,527438630490,556049475918,551729138316,550651284925,541165494737,556475611042,556706510802,555983216526,555968342664,557035599275,557415733343,556129883898,557629383718,557523797903,557520319146,556104926399,549119826615,529742081714,530281813566,540615955415,540897200164,521293158275,531500503266,539366124100,534744972408,538994488503,542337666603,534858684756,523737238926,532602538696,536197070876,551974843558,532076722056,554864744510,523807190227,542169018608,538154620073,547527269696,532603642908,538919766386,524745628731,555331179846,531172828125,538304988370,544414476882,539854982190,528810764279,545284938765,525270878896,556463945906,540697151157,556504330665,556381924347,556649222849,556564667288,542195205226,556748829452,557310941648,16505351217,556560439567,531493939222,529284034772,10913250663,17294079577,544472212317,523746256545,523714227013,555131768952,531851580743,43784059501,550202819632,536966655180,537116460739,542074632842,554898208704,525201313448,542312250718,533624811133,554006838827,543478873393,540297613200,555655691390,555093954396,541207980323,555659872253,556503430479,544747801155,546836425231,549054853892,544148616165,555112160241,546837829184,556619483265,556675173531,551384712523,554974610280,525272493108,545171724434,532805434133,550471860694,536716652876,537956016240,557974958856,557483651277,557394858514,549012007942,520943674824,530523414827,531160520044,556124949272,37617354273,538850144726,22299307129,533220367917,42289229310,548221327800,17345546169,44194355561,547424192250,549233039136,40706217867,541111225069,533265865255,533265533636,44029281730,547462201410,533333820511,551498170941,533802271835,558118695681,543565905141,550897989251,541055546258,555378118090,39548043169,521042072014,553104356806,555983216526,556096316188,555968342664,527394151312,541169531886,550490430145,551729138316,556049475918,557415733343,541165494737,557118993613,557248842593,557523797903,530463220461,557520319146,558017135229,527438630490,549119826615,551603875231,551498048745,553463924060,554856999941,523737238926,556649222849,529742081714,554864744510,538994488503,534858684756,531500503266,521293158275,539854982190,523807190227,542337666603,539366124100,530281813566,540897200164,540615955415,538154620073,533220474800,542169018608,556564667288,538919766386,532603642908,556463945906,531172828125,540697151157,524745628731,556504330665,534744972408,544414476882,556381924347,549344735426,532602538696,532076722056,551974843558,557310941648,545284938765,547527269696,538304988370,556081752511,528810764279,525270878896,10913250663,16505351217,555131768952,17294079577,531851580743,531493939222,556741930097,43784059501,523714227013,523746256545,556560439567,544472212317,555817706681,556619483265,542312250718,550471860694,556675173531,551384712523,554006838827,540297613200,555655691390,555093954396,547609622660,541207980323,556503430479,536966655180,555311716783,554974610280,544148616165,557726630671,545171724434,542074632842,547679701492,533624811133,543478873393,555659872253,546836425231,525272493108,556704658320,553901833920,546837829184,557166704414,558509883748,558577113629,557522715364,532805434133) and month=$month and (has_human!=88 or has_human is null) and shop_type in('天猫','天猫国际') and name not like '%日夜%'  group by tb_item_id,month order by sum(sales) desc limit 100) a left join dw_entity.brand b on a.alias_bid=b.bid ;";

		
		$data = Yii::$app->db->createCommand($sql)->queryAll();
		return $this->render('index',['data' => $data]);
		
	}
				  
	
	public function actionTmcscheck(){
		$month=1804;
		$sql="SELECT a.tb_item_id,a.name,shop_name,b.name as brand_name,month,ss,sn,avg from (SELECT tb_item_id,name,shop_name,alias_bid,month,sum(sales/100) ss,sum(num) sn,sum(sales/100)/sum(num) avg FROM artificial.entity_1359_item_final where is_mix=0 and tb_item_id not like '%\_%' and month=$month and (has_human!=88 or has_human is null) and tb_item_id not in(555678239580,555504724176,555679291520,555623386782,555504724176,555679291520,555678239580,555623386782,555679291520,555623386782,555678239580,555504724176) and shop_type in('天猫超市')  group by tb_item_id,month order by sum(sales) desc limit 100) a left join dw_entity.brand b on a.alias_bid=b.bid ;";
		$data = Yii::$app->db->createCommand($sql)->queryAll();
		//print_r($result);
		return $this->render('index',['data' => $data]);
		
		
	}
	
	public function actionTo_mix(){
		print_r($_GET);
		$tb_item_id=$_GET['id'];
		$actionID = Yii::$app->controller->action->id;
		$controllerID = Yii::$app->controller->id;
		//print_r(Yii::$app->request->getReferrer());
		if(strpos(Yii::$app->request->getReferrer(),'jdcheck')!== false){
			$sql="update artificial.entity_1359_jd_final set serface_material=NULL, is_import=NULL, size=NULL, classification='混合装', fragrance=NULL, insert_way=NULL, thick=NULL, b_num=NULL, p_num=NULL,is_mix=1,has_human=69 where tb_item_id=$tb_item_id and date='2018-04-01' ";
		}else{
			$sql="update artificial.entity_1359_item_final set serface_material=NULL, is_import=NULL, size=NULL, classification='混合装', fragrance=NULL, insert_way=NULL, thick=NULL, b_num=NULL, p_num=NULL,is_mix=1,has_human=69 where tb_item_id=$tb_item_id and month='1804' ";
		}
		echo $sql;
		Yii::$app->db->createCommand($sql)->execute();		
		//exit;
		return $this->goBack(Yii::$app->request->getReferrer());
		
		
		
		
	}
	

	
}
